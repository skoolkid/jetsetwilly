<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 8C4A</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8C01.html">8C01</a>
</td>
<td class="up">Up: <a href="../maps/all.html#8c4a">Map</a></td>
<td class="next">
Next: <a href="8D33.html">8D33</a>
</td>
</tr>
</table>
<div class="description">8C4A: Display the game over sequence</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="8C01.html">8C01</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="8c4a"></span>8C4A</td>
<td class="instruction">LD HL,$4000</td>
<td class="comment-1" rowspan="5">Clear the top two-thirds of the display file</td>
</tr>
<tr>
<td class="address-1"><span id="8c4d"></span>8C4D</td>
<td class="instruction">LD DE,$4001</td>
</tr>
<tr>
<td class="address-1"><span id="8c50"></span>8C50</td>
<td class="instruction">LD BC,$0FFF</td>
</tr>
<tr>
<td class="address-1"><span id="8c53"></span>8C53</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address-1"><span id="8c55"></span>8C55</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="8c57"></span>8C57</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Initialise the temporary game status buffer variable at <a href="85E4.html">85E4</a>; this variable will determine the distance of the foot from the top of the screen</td>
</tr>
<tr>
<td class="address-1"><span id="8c58"></span>8C58</td>
<td class="instruction">LD ($85E4),A</td>
</tr>
<tr>
<td class="address-1"><span id="8c5b"></span>8C5B</td>
<td class="instruction">LD DE,$9D40</td>
<td class="comment-1" rowspan="4">Draw Willy at (12,15)</td>
</tr>
<tr>
<td class="address-1"><span id="8c5e"></span>8C5E</td>
<td class="instruction">LD HL,$488F</td>
</tr>
<tr>
<td class="address-1"><span id="8c61"></span>8C61</td>
<td class="instruction">LD C,$00</td>
</tr>
<tr>
<td class="address-1"><span id="8c63"></span>8C63</td>
<td class="instruction">CALL <a href="9456.html">$9456</a></td>
</tr>
<tr>
<td class="address-1"><span id="8c66"></span>8C66</td>
<td class="instruction">LD DE,$9C60</td>
<td class="comment-1" rowspan="4">Draw the barrel underneath Willy at (14,15)</td>
</tr>
<tr>
<td class="address-1"><span id="8c69"></span>8C69</td>
<td class="instruction">LD HL,$48CF</td>
</tr>
<tr>
<td class="address-1"><span id="8c6c"></span>8C6C</td>
<td class="instruction">LD C,$00</td>
</tr>
<tr>
<td class="address-1"><span id="8c6e"></span>8C6E</td>
<td class="instruction">CALL <a href="9456.html">$9456</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8c71"></span>
<div class="comments">
<div class="paragraph">
The following loop draws the foot's descent onto the barrel that supports Willy while producing a sound effect.
</div>
<div class="paragraph">
<audio controls="" src="../audio/game-over.ogg">
<p>Your browser doesn't support HTML5 audio. Here is a <a href="../audio/game-over.ogg">link to the audio</a> instead.</p>
</audio>
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="8c71"></span>8C71</td>
<td class="instruction">LD A,($85E4)</td>
<td class="comment-1" rowspan="1">Pick up the distance variable from <a href="85E4.html">85E4</a></td>
</tr>
<tr>
<td class="address-1"><span id="8c74"></span>8C74</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">BC</span> at the corresponding entry in the screen buffer address lookup table at <a href="8200.html">8200</a></td>
</tr>
<tr>
<td class="address-1"><span id="8c75"></span>8C75</td>
<td class="instruction">LD B,$82</td>
</tr>
<tr>
<td class="address-1"><span id="8c77"></span>8C77</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="7">Point <span class="register">HL</span> at the corresponding location in the display file</td>
</tr>
<tr>
<td class="address-1"><span id="8c78"></span>8C78</td>
<td class="instruction">OR $0F</td>
</tr>
<tr>
<td class="address-1"><span id="8c7a"></span>8C7A</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="8c7b"></span>8C7B</td>
<td class="instruction">INC BC</td>
</tr>
<tr>
<td class="address-1"><span id="8c7c"></span>8C7C</td>
<td class="instruction">LD A,(BC)</td>
</tr>
<tr>
<td class="address-1"><span id="8c7d"></span>8C7D</td>
<td class="instruction">SUB $20</td>
</tr>
<tr>
<td class="address-1"><span id="8c7f"></span>8C7F</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="8c80"></span>8C80</td>
<td class="instruction">LD DE,$9C40</td>
<td class="comment-1" rowspan="3">Draw the foot at this location, without erasing the foot at the previous location; this leaves the portion of the foot sprite that's above the ankle in place, and makes the foot appear as if it's at the end of a long, extending leg</td>
</tr>
<tr>
<td class="address-1"><span id="8c83"></span>8C83</td>
<td class="instruction">LD C,$00</td>
</tr>
<tr>
<td class="address-1"><span id="8c85"></span>8C85</td>
<td class="instruction">CALL <a href="9456.html">$9456</a></td>
</tr>
<tr>
<td class="address-1"><span id="8c88"></span>8C88</td>
<td class="instruction">LD A,($85E4)</td>
<td class="comment-1" rowspan="1">Pick up the distance variable from <a href="85E4.html">85E4</a></td>
</tr>
<tr>
<td class="address-1"><span id="8c8b"></span>8C8B</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0xFF-<span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="8c8c"></span>8C8C</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Store this value (0x3F-0xFF) in <span class="register">E</span>; it determines the (rising) pitch of the sound effect that will be made</td>
</tr>
<tr>
<td class="address-1"><span id="8c8d"></span>8C8D</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0 (black border)</td>
</tr>
<tr>
<td class="address-1"><span id="8c8e"></span>8C8E</td>
<td class="instruction">LD BC,$0040</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=0x40; this value determines the duration of the sound effect</td>
</tr>
<tr>
<td class="address-2"><span id="8c91"></span>8C91</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-1" rowspan="6">Produce a short note whose pitch is determined by <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="8c93"></span>8C93</td>
<td class="instruction">XOR $18</td>
</tr>
<tr>
<td class="address-1"><span id="8c95"></span>8C95</td>
<td class="instruction">LD B,E</td>
</tr>
<tr>
<td class="address-2"><span id="8c96"></span>8C96</td>
<td class="instruction">DJNZ <a href="8C4A.html#8c96">$8C96</a></td>
</tr>
<tr>
<td class="address-1"><span id="8c98"></span>8C98</td>
<td class="instruction">DEC C</td>
</tr>
<tr>
<td class="address-1"><span id="8c99"></span>8C99</td>
<td class="instruction">JR NZ,<a href="8C4A.html#8c91">$8C91</a></td>
</tr>
<tr>
<td class="address-1"><span id="8c9b"></span>8C9B</td>
<td class="instruction">LD HL,$5800</td>
<td class="comment-1" rowspan="3">Prepare <span class="register">BC</span>, <span class="register">DE</span> and <span class="register">HL</span> for setting the attribute bytes in the top two-thirds of the screen</td>
</tr>
<tr>
<td class="address-1"><span id="8c9e"></span>8C9E</td>
<td class="instruction">LD DE,$5801</td>
</tr>
<tr>
<td class="address-1"><span id="8ca1"></span>8CA1</td>
<td class="instruction">LD BC,$01FF</td>
</tr>
<tr>
<td class="address-1"><span id="8ca4"></span>8CA4</td>
<td class="instruction">LD A,($85E4)</td>
<td class="comment-1" rowspan="1">Pick up the distance variable from <a href="85E4.html">85E4</a></td>
</tr>
<tr>
<td class="address-1"><span id="8ca7"></span>8CA7</td>
<td class="instruction">AND $0C</td>
<td class="comment-1" rowspan="1">Keep only bits 2 and 3</td>
</tr>
<tr>
<td class="address-1"><span id="8ca9"></span>8CA9</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="1">Shift bits 2 and 3 into bits 3 and 4; these bits determine the PAPER colour: 0, 1, 2 or 3</td>
</tr>
<tr>
<td class="address-1"><span id="8caa"></span>8CAA</td>
<td class="instruction">OR $47</td>
<td class="comment-1" rowspan="1">Set bits 0-2 (INK 7) and 6 (BRIGHT 1)</td>
</tr>
<tr>
<td class="address-1"><span id="8cac"></span>8CAC</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="2">Copy this attribute value into the top two-thirds of the screen</td>
</tr>
<tr>
<td class="address-1"><span id="8cad"></span>8CAD</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="8caf"></span>8CAF</td>
<td class="instruction">AND $FA</td>
<td class="comment-1" rowspan="1">Reset bits 0 and 2, and retain all other bits</td>
</tr>
<tr>
<td class="address-1"><span id="8cb1"></span>8CB1</td>
<td class="instruction">OR $02</td>
<td class="comment-1" rowspan="1">Set bit 1 (INK 2)</td>
</tr>
<tr>
<td class="address-1"><span id="8cb3"></span>8CB3</td>
<td class="instruction">LD ($59CF),A</td>
<td class="comment-1" rowspan="4">Copy this attribute value to the cells at (14,15), (14,16), (15, 15) and (15, 16) (where the barrel is, so that it remains red)</td>
</tr>
<tr>
<td class="address-1"><span id="8cb6"></span>8CB6</td>
<td class="instruction">LD ($59D0),A</td>
</tr>
<tr>
<td class="address-1"><span id="8cb9"></span>8CB9</td>
<td class="instruction">LD ($59EF),A</td>
</tr>
<tr>
<td class="address-1"><span id="8cbc"></span>8CBC</td>
<td class="instruction">LD ($59F0),A</td>
</tr>
<tr>
<td class="address-1"><span id="8cbf"></span>8CBF</td>
<td class="instruction">LD A,($85E4)</td>
<td class="comment-1" rowspan="3">Add 4 to the distance variable at <a href="85E4.html">85E4</a>; this will move the foot sprite down two pixel rows</td>
</tr>
<tr>
<td class="address-1"><span id="8cc2"></span>8CC2</td>
<td class="instruction">ADD A,$04</td>
</tr>
<tr>
<td class="address-1"><span id="8cc4"></span>8CC4</td>
<td class="instruction">LD ($85E4),A</td>
</tr>
<tr>
<td class="address-1"><span id="8cc7"></span>8CC7</td>
<td class="instruction">CP $C4</td>
<td class="comment-1" rowspan="1">Has the foot met the barrel yet?</td>
</tr>
<tr>
<td class="address-1"><span id="8cc9"></span>8CC9</td>
<td class="instruction">JR NZ,<a href="8C4A.html#8c71">$8C71</a></td>
<td class="comment-1" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8ccb"></span>
<div class="comments">
<div class="paragraph">
Now print the "Game Over" message, just to drive the point home.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="8ccb"></span>8CCB</td>
<td class="instruction">LD IX,$8574</td>
<td class="comment-1" rowspan="4">Print "Game" (see <a href="8574.html">8574</a>) at (6,10)</td>
</tr>
<tr>
<td class="address-1"><span id="8ccf"></span>8CCF</td>
<td class="instruction">LD C,$04</td>
</tr>
<tr>
<td class="address-1"><span id="8cd1"></span>8CD1</td>
<td class="instruction">LD DE,$40CA</td>
</tr>
<tr>
<td class="address-1"><span id="8cd4"></span>8CD4</td>
<td class="instruction">CALL <a href="9680.html">$9680</a></td>
</tr>
<tr>
<td class="address-1"><span id="8cd7"></span>8CD7</td>
<td class="instruction">LD IX,$8578</td>
<td class="comment-1" rowspan="4">Print "Over" (see <a href="8578.html">8578</a>) at (6,18)</td>
</tr>
<tr>
<td class="address-1"><span id="8cdb"></span>8CDB</td>
<td class="instruction">LD C,$04</td>
</tr>
<tr>
<td class="address-1"><span id="8cdd"></span>8CDD</td>
<td class="instruction">LD DE,$40D2</td>
</tr>
<tr>
<td class="address-1"><span id="8ce0"></span>8CE0</td>
<td class="instruction">CALL <a href="9680.html">$9680</a></td>
</tr>
<tr>
<td class="address-1"><span id="8ce3"></span>8CE3</td>
<td class="instruction">LD BC,$0000</td>
<td class="comment-1" rowspan="2">Prepare the delay counters for the following loop; the counter in <span class="register">C</span> will also determine the INK colours to use for the "Game Over" message</td>
</tr>
<tr>
<td class="address-1"><span id="8ce6"></span>8CE6</td>
<td class="instruction">LD D,$06</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8ce8"></span>
<div class="comments">
<div class="paragraph">
The following loop makes the "Game Over" message glisten for about 1.57s.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="8ce8"></span>8CE8</td>
<td class="instruction">DJNZ <a href="8C4A.html#8ce8">$8CE8</a></td>
<td class="comment-1" rowspan="1">Delay for about a millisecond</td>
</tr>
<tr>
<td class="address-1"><span id="8cea"></span>8CEA</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "G" in "Game" at (6,10)</td>
</tr>
<tr>
<td class="address-1"><span id="8ceb"></span>8CEB</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8ced"></span>8CED</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8cef"></span>8CEF</td>
<td class="instruction">LD ($58CA),A</td>
</tr>
<tr>
<td class="address-1"><span id="8cf2"></span>8CF2</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "a" in "Game" at (6,11)</td>
</tr>
<tr>
<td class="address-1"><span id="8cf3"></span>8CF3</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8cf5"></span>8CF5</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8cf7"></span>8CF7</td>
<td class="instruction">LD ($58CB),A</td>
</tr>
<tr>
<td class="address-1"><span id="8cfa"></span>8CFA</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "m" in "Game" at (6,12)</td>
</tr>
<tr>
<td class="address-1"><span id="8cfb"></span>8CFB</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8cfd"></span>8CFD</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8cff"></span>8CFF</td>
<td class="instruction">LD ($58CC),A</td>
</tr>
<tr>
<td class="address-1"><span id="8d02"></span>8D02</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "e" in "Game" at (6,13)</td>
</tr>
<tr>
<td class="address-1"><span id="8d03"></span>8D03</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8d05"></span>8D05</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8d07"></span>8D07</td>
<td class="instruction">LD ($58CD),A</td>
</tr>
<tr>
<td class="address-1"><span id="8d0a"></span>8D0A</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "O" in "Over" at (6,18)</td>
</tr>
<tr>
<td class="address-1"><span id="8d0b"></span>8D0B</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8d0d"></span>8D0D</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8d0f"></span>8D0F</td>
<td class="instruction">LD ($58D2),A</td>
</tr>
<tr>
<td class="address-1"><span id="8d12"></span>8D12</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "v" in "Over" at (6,19)</td>
</tr>
<tr>
<td class="address-1"><span id="8d13"></span>8D13</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8d15"></span>8D15</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8d17"></span>8D17</td>
<td class="instruction">LD ($58D3),A</td>
</tr>
<tr>
<td class="address-1"><span id="8d1a"></span>8D1A</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "e" in "Over" at (6,20)</td>
</tr>
<tr>
<td class="address-1"><span id="8d1b"></span>8D1B</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8d1d"></span>8D1D</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8d1f"></span>8D1F</td>
<td class="instruction">LD ($58D4),A</td>
</tr>
<tr>
<td class="address-1"><span id="8d22"></span>8D22</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Change the INK colour of the "r" in "Over" at (6,21)</td>
</tr>
<tr>
<td class="address-1"><span id="8d23"></span>8D23</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="8d25"></span>8D25</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="8d27"></span>8D27</td>
<td class="instruction">LD ($58D5),A</td>
</tr>
<tr>
<td class="address-1"><span id="8d2a"></span>8D2A</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Decrement the counter in <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="8d2b"></span>8D2B</td>
<td class="instruction">JR NZ,<a href="8C4A.html#8ce8">$8CE8</a></td>
<td class="comment-1" rowspan="1">Jump back unless it's zero</td>
</tr>
<tr>
<td class="address-1"><span id="8d2d"></span>8D2D</td>
<td class="instruction">DEC D</td>
<td class="comment-1" rowspan="1">Decrement the counter in <span class="register">D</span> (initially 6)</td>
</tr>
<tr>
<td class="address-1"><span id="8d2e"></span>8D2E</td>
<td class="instruction">JR NZ,<a href="8C4A.html#8ce8">$8CE8</a></td>
<td class="comment-1" rowspan="1">Jump back unless it's zero</td>
</tr>
<tr>
<td class="address-1"><span id="8d30"></span>8D30</td>
<td class="instruction">JP <a href="87CA.html">$87CA</a></td>
<td class="comment-1" rowspan="1">Display the title screen and play the theme tune</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8C01.html">8C01</a>
</td>
<td class="up">Up: <a href="../maps/all.html#8c4a">Map</a></td>
<td class="next">
Next: <a href="8D33.html">8D33</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20221122</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/35914.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>