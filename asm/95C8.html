<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 95C8</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="959A.html">959A</a></span></td>
<td class="up">Up: <a href="../maps/all.html#95c8">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="961E.html">961E</a></span></td>
</tr>
</table>
<div class="description">95C8: Check and set the attribute bytes for Willy's sprite in the buffer at 5C00</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="89AD.html">89AD</a>. Sets the attribute bytes in the buffer at <a href="5C00.html">5C00</a> for the six cells (in three rows of two) occupied by or under Willy's sprite, or kills Willy if any of the cells contains a nasty.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="95c8"></span>95C8</td>
<td class="instruction">LD HL,($85D3)</td>
<td class="comment-11" rowspan="1">Pick up Willy's attribute buffer coordinates from <a href="85D3.html">85D3</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95cb"></span>95CB</td>
<td class="instruction">LD B,$00</td>
<td class="comment-11" rowspan="1">Initialise <span class="register">B</span> to 0 (in case Willy is not standing on a ramp)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95cd"></span>95CD</td>
<td class="instruction">LD A,($80DA)</td>
<td class="comment-11" rowspan="1">Pick up the direction byte of the ramp definition for the current room from <a href="80DA.html">80DA</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95d0"></span>95D0</td>
<td class="instruction">AND $01</td>
<td class="comment-11" rowspan="5">Point <span class="register">HL</span> at one of the cells under Willy's feet (the one on the left if the ramp goes up to the left, the one on the right if the ramp goes up to the right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95d2"></span>95D2</td>
<td class="instruction">ADD A,$40</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95d4"></span>95D4</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95d5"></span>95D5</td>
<td class="instruction">LD D,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95d7"></span>95D7</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95d8"></span>95D8</td>
<td class="instruction">LD A,($80C4)</td>
<td class="comment-11" rowspan="1">Pick up the ramp's attribute byte from <a href="80A0.html#80c4">80C4</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95db"></span>95DB</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is Willy on or just above the ramp?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95dc"></span>95DC</td>
<td class="instruction">JR NZ,<a href="95C8.html#95f8">$95F8</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95de"></span>95DE</td>
<td class="instruction">LD A,($85D1)</td>
<td class="comment-11" rowspan="1">Pick up the airborne status indicator from <a href="85D1.html">85D1</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95e1"></span>95E1</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">Is Willy airborne?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95e2"></span>95E2</td>
<td class="instruction">JR NZ,<a href="95C8.html#95f8">$95F8</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="95e4"></span>
<div class="comments">
<div class="paragraph">
Willy is standing on a ramp. Calculate the offset that needs to be added to the y-coordinate stored at <a href="85CF.html">85CF</a> to obtain Willy's true pixel y-coordinate.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95e4"></span>95E4</td>
<td class="instruction">LD A,($85D2)</td>
<td class="comment-11" rowspan="1">Pick up Willy's current animation frame (0-3) from <a href="85D2.html">85D2</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95e7"></span>95E7</td>
<td class="instruction">AND $03</td>
<td class="comment-11" rowspan="4"><span class="register">B</span>=0, 4, 8 or 12</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95e9"></span>95E9</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95ea"></span>95EA</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95eb"></span>95EB</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95ec"></span>95EC</td>
<td class="instruction">LD A,($80DA)</td>
<td class="comment-11" rowspan="1">Pick up the direction byte of the ramp definition for the current room from <a href="80DA.html">80DA</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95ef"></span>95EF</td>
<td class="instruction">AND $01</td>
<td class="comment-11" rowspan="5"><span class="register">A</span>=<span class="register">B</span> (if the ramp goes up to the left) or 12-<span class="register">B</span> (if the ramp goes up to the right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95f1"></span>95F1</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95f2"></span>95F2</td>
<td class="instruction">XOR $0C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95f4"></span>95F4</td>
<td class="instruction">XOR B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95f5"></span>95F5</td>
<td class="instruction">AND $0C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95f7"></span>95F7</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy this value to <span class="register">B</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="95f8"></span>
<div class="comments">
<div class="paragraph">
Now <span class="register">B</span> holds a y-coordinate offset of 0, 4, 8 or 12 if Willy is standing on a ramp, or 0 otherwise.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="95f8"></span>95F8</td>
<td class="instruction">LD HL,($85D3)</td>
<td class="comment-11" rowspan="1">Pick up Willy's attribute buffer coordinates from <a href="85D3.html">85D3</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95fb"></span>95FB</td>
<td class="instruction">LD DE,$001F</td>
<td class="comment-11" rowspan="1">Prepare <span class="register">DE</span> for later addition</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="95fe"></span>95FE</td>
<td class="instruction">LD C,$0F</td>
<td class="comment-11" rowspan="1">Set <span class="register">C</span>=15 for the top two rows of cells (to make the routine at <a href="961E.html">961E</a> force white INK)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9600"></span>9600</td>
<td class="instruction">CALL <a href="961E.html">$961E</a></td>
<td class="comment-11" rowspan="1">Check and set the attribute byte for the top-left cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9603"></span>9603</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Move <span class="register">HL</span> to the next cell to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9604"></span>9604</td>
<td class="instruction">CALL <a href="961E.html">$961E</a></td>
<td class="comment-11" rowspan="1">Check and set the attribute byte for the top-right cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9607"></span>9607</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1">Move <span class="register">HL</span> down a row and back one cell to the left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9608"></span>9608</td>
<td class="instruction">CALL <a href="961E.html">$961E</a></td>
<td class="comment-11" rowspan="1">Check and set the attribute byte for the mid-left cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="960b"></span>960B</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Move <span class="register">HL</span> to the next cell to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="960c"></span>960C</td>
<td class="instruction">CALL <a href="961E.html">$961E</a></td>
<td class="comment-11" rowspan="1">Check and set the attribute byte for the mid-right cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="960f"></span>960F</td>
<td class="instruction">LD A,($85CF)</td>
<td class="comment-11" rowspan="1">Pick up Willy's pixel y-coordinate from <a href="85CF.html">85CF</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9612"></span>9612</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="2">Add the y-coordinate offset calculated earlier (to get Willy's true pixel y-coordinate if he's standing on a ramp) and transfer the result to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9613"></span>9613</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9614"></span>9614</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1">Move <span class="register">HL</span> down a row and back one cell to the left; at this point <span class="register">HL</span> may be pointing at one of the cells in the top row of the buffer at <a href="5E00.html">5E00</a>, which is a <a href="../reference/bugs.html#longDistanceNasties">bug</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9615"></span>9615</td>
<td class="instruction">CALL <a href="961E.html">$961E</a></td>
<td class="comment-11" rowspan="1">Check and set the attribute byte for the bottom-left cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9618"></span>9618</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Move <span class="register">HL</span> to the next cell to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9619"></span>9619</td>
<td class="instruction">CALL <a href="961E.html">$961E</a></td>
<td class="comment-11" rowspan="1">Check and set the attribute byte for the bottom-right cell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="961c"></span>961C</td>
<td class="instruction">JR <a href="9637.html">$9637</a></td>
<td class="comment-11" rowspan="1">Draw Willy to the screen buffer at <a href="6000.html">6000</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="959A.html">959A</a></span></td>
<td class="up">Up: <a href="../maps/all.html#95c8">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="961E.html">961E</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20160511</div>
<div class="copyright">&#169; 1984 Software Projects Ltd (Jet Set Willy). &#169; 2016 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.2.</div>
</footer>
</body>
</html>