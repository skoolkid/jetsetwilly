<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 93D1</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="93BB.html">93BB</a></span></td>
<td class="up">Up: <a href="../maps/all.html#93d1">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="9456.html">9456</a></span></td>
</tr>
</table>
<div class="description">93D1: Draw the items in the current room and collect any that Willy is touching</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="89AD.html">89AD</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="93d1"></span>93D1</td>
<td class="instruction">LD H,$A4</td>
<td class="comment-11" rowspan="1">Page <a href="A400.html">164</a> holds the first byte of each entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93d3"></span>93D3</td>
<td class="instruction">LD A,($A3FF)</td>
<td class="comment-11" rowspan="1">Pick up the index of the first item from <a href="A3FF.html">A3FF</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93d6"></span>93D6</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the first byte of the first entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="93d7"></span>
<div class="comments">
<div class="paragraph">
The item-drawing loop begins here.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="93d7"></span>93D7</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the first byte of the current entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93d8"></span>93D8</td>
<td class="instruction">RES 7,C</td>
<td class="comment-11" rowspan="1">Reset bit 7; bit 6 holds the collection flag, and bits 0-5 hold the room number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93da"></span>93DA</td>
<td class="instruction">LD A,($8420)</td>
<td class="comment-11" rowspan="1">Pick up the number of the current room from <a href="8420.html">8420</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93dd"></span>93DD</td>
<td class="instruction">OR $40</td>
<td class="comment-11" rowspan="1">Set bit 6 (corresponding to the collection flag)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93df"></span>93DF</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="1">Is the item in the current room and still uncollected?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93e0"></span>93E0</td>
<td class="instruction">JR NZ,<a href="93D1.html#9452">$9452</a></td>
<td class="comment-11" rowspan="1">If not, jump to consider the next entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="93e2"></span>
<div class="comments">
<div class="paragraph">
This item is in the current room and has not been collected yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93e2"></span>93E2</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the first byte of the current entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93e3"></span>93E3</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="7">Point <span class="register">DE</span> at the location of the item in the attribute buffer at <a href="5C00.html">5C00</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93e4"></span>93E4</td>
<td class="instruction">AND $01</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93e6"></span>93E6</td>
<td class="instruction">ADD A,$5C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93e8"></span>93E8</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93e9"></span>93E9</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93ea"></span>93EA</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93eb"></span>93EB</td>
<td class="instruction">DEC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93ec"></span>93EC</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the current attribute byte at the item's location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93ed"></span>93ED</td>
<td class="instruction">AND $07</td>
<td class="comment-11" rowspan="2">Is the INK white (which happens if Willy is touching the item, or the room's background tile has white INK, as in <a href="DF00.html">Swimming Pool</a>)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93ef"></span>93EF</td>
<td class="instruction">CP $07</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93f1"></span>93F1</td>
<td class="instruction">JR NZ,<a href="93D1.html#9430">$9430</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="93f3"></span>
<div class="comments">
<div class="paragraph">
Willy is touching this item (or the room's background tile has white INK), so add it to his collection.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93f3"></span>93F3</td>
<td class="instruction">LD IX,$857C</td>
<td class="comment-11" rowspan="1">Point <span class="register">IX</span> at the number of items collected at <a href="857C.html">857C</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="93f7"></span>93F7</td>
<td class="instruction">INC (IX+$02)</td>
<td class="comment-11" rowspan="1">Increment a digit of the number of items collected</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93fa"></span>93FA</td>
<td class="instruction">LD A,(IX+$02)</td>
<td class="comment-11" rowspan="2">Was the digit originally '9'?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93fd"></span>93FD</td>
<td class="instruction">CP $3A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="93ff"></span>93FF</td>
<td class="instruction">JR NZ,<a href="93D1.html#9409">$9409</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9401"></span>9401</td>
<td class="instruction">LD (IX+$02),$30</td>
<td class="comment-11" rowspan="1">Set the digit to '0'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9405"></span>9405</td>
<td class="instruction">DEC IX</td>
<td class="comment-11" rowspan="1">Move back to the digit on the left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9407"></span>9407</td>
<td class="instruction">JR <a href="93D1.html#93f7">$93F7</a></td>
<td class="comment-11" rowspan="1">Jump back to increment this digit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="9409"></span>9409</td>
<td class="instruction">LD A,($80DE)</td>
<td class="comment-11" rowspan="1">Pick up the border colour for the current room from <a href="80DE.html">80DE</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="940c"></span>940C</td>
<td class="instruction">LD C,$80</td>
<td class="comment-11" rowspan="12">Produce the sound effect for collecting an item</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="940e"></span>940E</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9410"></span>9410</td>
<td class="instruction">XOR $18</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9412"></span>9412</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9413"></span>9413</td>
<td class="instruction">LD A,$90</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9415"></span>9415</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9416"></span>9416</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9417"></span>9417</td>
<td class="instruction">LD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="9418"></span>9418</td>
<td class="instruction">DJNZ <a href="93D1.html#9418">$9418</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="941a"></span>941A</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="941b"></span>941B</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="941c"></span>941C</td>
<td class="instruction">JR NZ,<a href="93D1.html#940e">$940E</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="941e"></span>941E</td>
<td class="instruction">LD A,($85DE)</td>
<td class="comment-11" rowspan="3">Update the counter of items remaining at <a href="85DE.html">85DE</a>, and set the zero flag if there are no more items to collect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9421"></span>9421</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9422"></span>9422</td>
<td class="instruction">LD ($85DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9425"></span>9425</td>
<td class="instruction">JR NZ,<a href="93D1.html#942c">$942C</a></td>
<td class="comment-11" rowspan="1">Jump if there are any items still to be collected</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9427"></span>9427</td>
<td class="instruction">LD A,$01</td>
<td class="comment-11" rowspan="2">Update the game mode indicator at <a href="85DF.html">85DF</a> to 1 (all items collected)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9429"></span>9429</td>
<td class="instruction">LD ($85DF),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="942c"></span>942C</td>
<td class="instruction">RES 6,(HL)</td>
<td class="comment-11" rowspan="1">Reset bit 6 of the first byte of the entry in the item table: the item has been collected</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="942e"></span>942E</td>
<td class="instruction">JR <a href="93D1.html#9452">$9452</a></td>
<td class="comment-11" rowspan="1">Jump to consider the next entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="9430"></span>
<div class="comments">
<div class="paragraph">
Willy is not touching this item, so draw it and cycle its INK colour.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="9430"></span>9430</td>
<td class="instruction">LD A,($85CB)</td>
<td class="comment-11" rowspan="5">Generate the INK colour for the item from the value of the minute counter at <a href="85CB.html">85CB</a> (0-255) and the index of the item in the item table (173-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9433"></span>9433</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9434"></span>9434</td>
<td class="instruction">AND $03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9436"></span>9436</td>
<td class="instruction">ADD A,$03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9438"></span>9438</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9439"></span>9439</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="4">Change the INK colour of the item in the attribute buffer at <a href="5C00.html">5C00</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="943a"></span>943A</td>
<td class="instruction">AND $F8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="943c"></span>943C</td>
<td class="instruction">OR C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="943d"></span>943D</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="943e"></span>943E</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="8">Point <span class="register">DE</span> at the location of the item in the screen buffer at <a href="6000.html">6000</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="943f"></span>943F</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9440"></span>9440</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9441"></span>9441</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9442"></span>9442</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9443"></span>9443</td>
<td class="instruction">AND $08</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9445"></span>9445</td>
<td class="instruction">ADD A,$60</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9447"></span>9447</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9448"></span>9448</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save <span class="register">HL</span> briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9449"></span>9449</td>
<td class="instruction">LD HL,$80E1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the item graphic for the current room (at <a href="80E1.html">80E1</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="944c"></span>944C</td>
<td class="instruction">LD B,$08</td>
<td class="comment-11" rowspan="1">There are eight pixel rows to copy</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="944e"></span>944E</td>
<td class="instruction">CALL <a href="9691.html#969b">$969B</a></td>
<td class="comment-11" rowspan="1">Draw the item to the screen buffer at <a href="6000.html">6000</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9451"></span>9451</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the item table pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="9452"></span>
<div class="comments">
<div class="paragraph">
The current item has been dealt with (skipped, collected or drawn) as appropriate. Time to consider the next one.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="9452"></span>9452</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the first byte of the next entry in the item table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9453"></span>9453</td>
<td class="instruction">JR NZ,<a href="93D1.html#93d7">$93D7</a></td>
<td class="comment-11" rowspan="1">Jump back unless we've examined every entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="9455"></span>9455</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="93BB.html">93BB</a></span></td>
<td class="up">Up: <a href="../maps/all.html#93d1">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="9456.html">9456</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20160117</div>
<div class="copyright">&#169; 1984 Software Projects Ltd (Jet Set Willy). &#169; 2016 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.1.</div>
</footer>
</body>
</html>