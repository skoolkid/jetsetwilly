<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 8DD3</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="8DC0.html">8DC0</a></span></td>
<td class="up">Up: <a href="../maps/all.html#8dd3">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="8ED4.html">8ED4</a></span></td>
</tr>
</table>
<div class="description">8DD3: Move Willy (1)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="89AD.html">89AD</a>. This routine deals with Willy if he's jumping or falling.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8dd3"></span>8DD3</td>
<td class="instruction">LD A,($85D6)</td>
<td class="comment-11" rowspan="1">Pick up the rope status indicator from <a href="85D6.html">85D6</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dd6"></span>8DD6</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="2">Is Willy on a rope?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dd7"></span>8DD7</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dd9"></span>8DD9</td>
<td class="instruction">JP Z,<a href="8ED4.html">$8ED4</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ddc"></span>8DDC</td>
<td class="instruction">LD A,($85D1)</td>
<td class="comment-11" rowspan="1">Pick up the airborne status indicator from <a href="85D1.html">85D1</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ddf"></span>8DDF</td>
<td class="instruction">CP $01</td>
<td class="comment-11" rowspan="1">Is Willy jumping?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8de1"></span>8DE1</td>
<td class="instruction">JR NZ,<a href="8DD3.html#8e36">$8E36</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="8de3"></span>
<div class="comments">
<div class="paragraph">
Willy is currently jumping.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8de3"></span>8DE3</td>
<td class="instruction">LD A,($85D5)</td>
<td class="comment-11" rowspan="1">Pick up the jumping animation counter (0-17) from <a href="85D5.html">85D5</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8de6"></span>8DE6</td>
<td class="instruction">AND $FE</td>
<td class="comment-11" rowspan="1">Discard bit 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8de8"></span>8DE8</td>
<td class="instruction">SUB $08</td>
<td class="comment-11" rowspan="1">Now -8&lt;=<span class="register">A</span>&lt;=8 (and <span class="register">A</span> is even)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dea"></span>8DEA</td>
<td class="instruction">LD HL,$85CF</td>
<td class="comment-11" rowspan="3">Adjust Willy's pixel y-coordinate at <a href="85CF.html">85CF</a> depending on where Willy is in the jump</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ded"></span>8DED</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dee"></span>8DEE</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8def"></span>8DEF</td>
<td class="instruction">CP $F0</td>
<td class="comment-11" rowspan="1">Is the new value negative (above the top of the screen)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8df1"></span>8DF1</td>
<td class="instruction">JP NC,<a href="94B0.html">$94B0</a></td>
<td class="comment-11" rowspan="1">If so, move Willy into the room above</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8df4"></span>8DF4</td>
<td class="instruction">CALL <a href="8DD3.html#8e9c">$8E9C</a></td>
<td class="comment-11" rowspan="1">Adjust Willy's attribute buffer location at <a href="85D3.html">85D3</a> depending on his pixel y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8df7"></span>8DF7</td>
<td class="instruction">LD A,($80B2)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte of the wall tile for the current room from <a href="80A0.html#80b2">80B2</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dfa"></span>8DFA</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is the top-left cell of Willy's sprite overlapping a wall tile?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dfb"></span>8DFB</td>
<td class="instruction">JP Z,<a href="8DD3.html#8ebc">$8EBC</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dfe"></span>8DFE</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the top-right cell occupied by Willy's sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8dff"></span>8DFF</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is the top-right cell of Willy's sprite overlapping a wall tile?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e00"></span>8E00</td>
<td class="instruction">JP Z,<a href="8DD3.html#8ebc">$8EBC</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e03"></span>8E03</td>
<td class="instruction">LD A,($85D5)</td>
<td class="comment-11" rowspan="3">Increment the jumping animation counter at <a href="85D5.html">85D5</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e06"></span>8E06</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e07"></span>8E07</td>
<td class="instruction">LD ($85D5),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e0a"></span>8E0A</td>
<td class="instruction">SUB $08</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=J-8, where J (1-18) is the new value of the jumping animation counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e0c"></span>8E0C</td>
<td class="instruction">JP P,<a href="8DD3.html#8e11">$8E11</a></td>
<td class="comment-11" rowspan="1">Jump if J&gt;=8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e0f"></span>8E0F</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=8-J (1&lt;=J&lt;=7, 1&lt;=<span class="register">A</span>&lt;=7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e11"></span>8E11</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1+ABS(J-8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e12"></span>8E12</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="4"><span class="register">D</span>=8*(1+ABS(J-8)); this value determines the pitch of the jumping sound effect (rising as Willy rises, falling as Willy falls)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e13"></span>8E13</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e14"></span>8E14</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e15"></span>8E15</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e16"></span>8E16</td>
<td class="instruction">LD C,$20</td>
<td class="comment-11" rowspan="1">This value determines the duration of the jumping sound effect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e18"></span>8E18</td>
<td class="instruction">LD A,($80DE)</td>
<td class="comment-11" rowspan="1">Pick up the border colour for the current room from <a href="80DE.html">80DE</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e1b"></span>8E1B</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-11" rowspan="6">Make a jumping sound effect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e1d"></span>8E1D</td>
<td class="instruction">XOR $18</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e1f"></span>8E1F</td>
<td class="instruction">LD B,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e20"></span>8E20</td>
<td class="instruction">DJNZ <a href="8DD3.html#8e20">$8E20</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e22"></span>8E22</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e23"></span>8E23</td>
<td class="instruction">JR NZ,<a href="8DD3.html#8e1b">$8E1B</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e25"></span>8E25</td>
<td class="instruction">LD A,($85D5)</td>
<td class="comment-11" rowspan="1">Pick up the jumping animation counter (1-18) from <a href="85D5.html">85D5</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e28"></span>8E28</td>
<td class="instruction">CP $12</td>
<td class="comment-11" rowspan="1">Has Willy reached the end of the jump?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e2a"></span>8E2A</td>
<td class="instruction">JP Z,<a href="8DD3.html#8eb0">$8EB0</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e2d"></span>8E2D</td>
<td class="instruction">CP $10</td>
<td class="comment-11" rowspan="1">Is the jumping animation counter now 16?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e2f"></span>8E2F</td>
<td class="instruction">JR Z,<a href="8DD3.html#8e36">$8E36</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e31"></span>8E31</td>
<td class="instruction">CP $0D</td>
<td class="comment-11" rowspan="1">Is the jumping animation counter now 13?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e33"></span>8E33</td>
<td class="instruction">JP NZ,<a href="8FBC.html">$8FBC</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="8e36"></span>
<div class="comments">
<div class="paragraph">
If we get here, then Willy is standing on the floor or a ramp, or he's falling, or his jumping animation counter is 13 (at which point Willy is on his way down and is exactly two cell-heights above where he started the jump) or 16 (at which point Willy is on his way down and is exactly one cell-height above where he started the jump).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e36"></span>8E36</td>
<td class="instruction">LD A,($85CF)</td>
<td class="comment-11" rowspan="1">Pick up Willy's pixel y-coordinate from <a href="85CF.html">85CF</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e39"></span>8E39</td>
<td class="instruction">AND $0E</td>
<td class="comment-11" rowspan="1">Is Willy either on a ramp, or occupying only four cells?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e3b"></span>8E3B</td>
<td class="instruction">JR NZ,<a href="8DD3.html#8e62">$8E62</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e3d"></span>8E3D</td>
<td class="instruction">LD HL,($85D3)</td>
<td class="comment-11" rowspan="1">Pick up Willy's attribute buffer coordinates from <a href="85D3.html">85D3</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e40"></span>8E40</td>
<td class="instruction">LD DE,$0040</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at the left-hand cell below Willy's sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e43"></span>8E43</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e44"></span>8E44</td>
<td class="instruction">BIT 1,H</td>
<td class="comment-11" rowspan="1">Is this location below the floor of the current room?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e46"></span>8E46</td>
<td class="instruction">JP NZ,<a href="94D2.html">$94D2</a></td>
<td class="comment-11" rowspan="1">If so, move Willy into the room below</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e49"></span>8E49</td>
<td class="instruction">LD A,($80BB)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte of the nasty tile for the current room from <a href="80A0.html#80bb">80BB</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e4c"></span>8E4C</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Does the left-hand cell below Willy's sprite contain a nasty?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e4d"></span>8E4D</td>
<td class="instruction">JR Z,<a href="8DD3.html#8e62">$8E62</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e4f"></span>8E4F</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the right-hand cell below Willy's sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e50"></span>8E50</td>
<td class="instruction">LD A,($80BB)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte of the nasty tile for the current room from <a href="80A0.html#80bb">80BB</a> (again, redundantly)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e53"></span>8E53</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Does the right-hand cell below Willy's sprite contain a nasty?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e54"></span>8E54</td>
<td class="instruction">JR Z,<a href="8DD3.html#8e62">$8E62</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e56"></span>8E56</td>
<td class="instruction">LD A,($80A0)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte of the background tile for the current room from <a href="80A0.html">80A0</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e59"></span>8E59</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Set the zero flag if the right-hand cell below Willy's sprite is empty</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e5a"></span>8E5A</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the left-hand cell below Willy's sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e5b"></span>8E5B</td>
<td class="instruction">JP NZ,<a href="8ED4.html">$8ED4</a></td>
<td class="comment-11" rowspan="1">Jump if the right-hand cell below Willy's sprite is not empty</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e5e"></span>8E5E</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is the left-hand cell below Willy's sprite empty?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e5f"></span>8E5F</td>
<td class="instruction">JP NZ,<a href="8ED4.html">$8ED4</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e62"></span>8E62</td>
<td class="instruction">LD A,($85D1)</td>
<td class="comment-11" rowspan="1">Pick up the airborne status indicator from <a href="85D1.html">85D1</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e65"></span>8E65</td>
<td class="instruction">CP $01</td>
<td class="comment-11" rowspan="1">Is Willy jumping?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e67"></span>8E67</td>
<td class="instruction">JP Z,<a href="8FBC.html">$8FBC</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="8e6a"></span>
<div class="comments">
<div class="paragraph">
If we get here, then Willy is either in the process of falling or just about to start falling.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e6a"></span>8E6A</td>
<td class="instruction">LD HL,$85D0</td>
<td class="comment-11" rowspan="2">Reset bit 1 at <a href="85D0.html">85D0</a>: Willy is not moving left or right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e6d"></span>8E6D</td>
<td class="instruction">RES 1,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e6f"></span>8E6F</td>
<td class="instruction">LD A,($85D1)</td>
<td class="comment-11" rowspan="1">Pick up the airborne status indicator from <a href="85D1.html">85D1</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e72"></span>8E72</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">Is Willy already falling?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e73"></span>8E73</td>
<td class="instruction">JP Z,<a href="8DD3.html#8eb6">$8EB6</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e76"></span>8E76</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Increment the airborne status indicator</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e77"></span>8E77</td>
<td class="instruction">CP $10</td>
<td class="comment-11" rowspan="1">Is it 16 now?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e79"></span>8E79</td>
<td class="instruction">JR NZ,<a href="8DD3.html#8e7d">$8E7D</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e7b"></span>8E7B</td>
<td class="instruction">LD A,$0C</td>
<td class="comment-11" rowspan="1">Decrease the airborne status indicator from 0x10 to 0x0C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e7d"></span>8E7D</td>
<td class="instruction">LD ($85D1),A</td>
<td class="comment-11" rowspan="1">Update the airborne status indicator at <a href="85D1.html">85D1</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e80"></span>8E80</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="5"><span class="register">D</span>=16*<span class="register">A</span>; this value determines the pitch of the falling sound effect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e81"></span>8E81</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e82"></span>8E82</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e83"></span>8E83</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e84"></span>8E84</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e85"></span>8E85</td>
<td class="instruction">LD C,$20</td>
<td class="comment-11" rowspan="1">This value determines the duration of the falling sound effect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e87"></span>8E87</td>
<td class="instruction">LD A,($80DE)</td>
<td class="comment-11" rowspan="1">Pick up the border colour for the current room from <a href="80DE.html">80DE</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e8a"></span>8E8A</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-11" rowspan="6">Make a falling sound effect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e8c"></span>8E8C</td>
<td class="instruction">XOR $18</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e8e"></span>8E8E</td>
<td class="instruction">LD B,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e8f"></span>8E8F</td>
<td class="instruction">DJNZ <a href="8DD3.html#8e8f">$8E8F</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e91"></span>8E91</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e92"></span>8E92</td>
<td class="instruction">JR NZ,<a href="8DD3.html#8e8a">$8E8A</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e94"></span>8E94</td>
<td class="instruction">LD A,($85CF)</td>
<td class="comment-11" rowspan="3">Add 8 to Willy's pixel y-coordinate at <a href="85CF.html">85CF</a>; this moves Willy downwards by 4 pixels</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e97"></span>8E97</td>
<td class="instruction">ADD A,$08</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e99"></span>8E99</td>
<td class="instruction">LD ($85CF),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="8e9c"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="91BE.html">91BE</a> to update Willy's attribute buffer location when he's on a rope.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8e9c"></span>8E9C</td>
<td class="instruction">AND $F0</td>
<td class="comment-11" rowspan="2"><span class="register">L</span>=16*Y, where Y is Willy's screen y-coordinate (0-14)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e9e"></span>8E9E</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8e9f"></span>8E9F</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Clear <span class="register">A</span> and the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ea0"></span>8EA0</td>
<td class="instruction">RL L</td>
<td class="comment-11" rowspan="1">Now <span class="register">L</span>=32*(Y-8*INT(Y/8)), and the carry flag is set if Willy is in the lower half of the room (Y&gt;=8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ea2"></span>8EA2</td>
<td class="instruction">ADC A,$5C</td>
<td class="comment-11" rowspan="2"><span class="register">H</span>=0x5C or 0x5D (MSB of the address of Willy's location in the attribute buffer)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ea4"></span>8EA4</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ea5"></span>8EA5</td>
<td class="instruction">LD A,($85D3)</td>
<td class="comment-11" rowspan="2">Pick up Willy's screen x-coordinate (0-30) from bits 0-4 at <a href="85D3.html">85D3</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ea8"></span>8EA8</td>
<td class="instruction">AND $1F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8eaa"></span>8EAA</td>
<td class="instruction">OR L</td>
<td class="comment-11" rowspan="2">Now <span class="register">L</span> holds the LSB of Willy's attribute buffer address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8eab"></span>8EAB</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8eac"></span>8EAC</td>
<td class="instruction">LD ($85D3),HL</td>
<td class="comment-11" rowspan="1">Store Willy's updated attribute buffer location at <a href="85D3.html">85D3</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8eaf"></span>8EAF</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="8eb0"></span>
<div class="comments">
<div class="paragraph">
Willy has just finished a jump.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8eb0"></span>8EB0</td>
<td class="instruction">LD A,$06</td>
<td class="comment-11" rowspan="2">Set the airborne status indicator at <a href="85D1.html">85D1</a> to 0x06: Willy will continue to fall unless he's landed on a wall or floor block</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8eb2"></span>8EB2</td>
<td class="instruction">LD ($85D1),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8eb5"></span>8EB5</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="8eb6"></span>
<div class="comments">
<div class="paragraph">
Willy has just started falling.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8eb6"></span>8EB6</td>
<td class="instruction">LD A,$02</td>
<td class="comment-11" rowspan="2">Set the airborne status indicator at <a href="85D1.html">85D1</a> to 0x02</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8eb8"></span>8EB8</td>
<td class="instruction">LD ($85D1),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ebb"></span>8EBB</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="8ebc"></span>
<div class="comments">
<div class="paragraph">
The top-left or top-right cell of Willy's sprite is overlapping a wall tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="8ebc"></span>8EBC</td>
<td class="instruction">LD A,($85CF)</td>
<td class="comment-11" rowspan="4">Adjust Willy's pixel y-coordinate at <a href="85CF.html">85CF</a> so that the top row of cells of his sprite is just below the wall tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ebf"></span>8EBF</td>
<td class="instruction">ADD A,$10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ec1"></span>8EC1</td>
<td class="instruction">AND $F0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ec3"></span>8EC3</td>
<td class="instruction">LD ($85CF),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ec6"></span>8EC6</td>
<td class="instruction">CALL <a href="8DD3.html#8e9c">$8E9C</a></td>
<td class="comment-11" rowspan="1">Adjust Willy's attribute buffer location at <a href="85D3.html">85D3</a> to account for this new pixel y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ec9"></span>8EC9</td>
<td class="instruction">LD A,$02</td>
<td class="comment-11" rowspan="2">Set the airborne status indicator at <a href="85D1.html">85D1</a> to 0x02: Willy has started falling</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ecb"></span>8ECB</td>
<td class="instruction">LD ($85D1),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ece"></span>8ECE</td>
<td class="instruction">LD HL,$85D0</td>
<td class="comment-11" rowspan="2">Reset bit 1 at <a href="85D0.html">85D0</a>: Willy is not moving left or right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ed1"></span>8ED1</td>
<td class="instruction">RES 1,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="8ed3"></span>8ED3</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="8DC0.html">8DC0</a></span></td>
<td class="up">Up: <a href="../maps/all.html#8dd3">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="8ED4.html">8ED4</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20181016</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2018 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 7.0.</div>
<div><a href="http://skoolkit.ca/disassemblies/jet_set_willy/asm/36307.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>