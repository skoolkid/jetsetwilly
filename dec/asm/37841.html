<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 37841</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37819.html">37819</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37841">Map</a></td>
<td class="next">
Next: <a href="37974.html">37974</a>
</td>
</tr>
</table>
<div class="description">37841: Draw the items in the current room and collect any that Willy is touching</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="35245.html">35245</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37841"></span>37841</td>
<td class="instruction">LD H,164</td>
<td class="comment-1" rowspan="1">Page <a href="41984.html">164</a> holds the first byte of each entry in the item table</td>
</tr>
<tr>
<td class="address-1"><span id="37843"></span>37843</td>
<td class="instruction">LD A,(41983)</td>
<td class="comment-1" rowspan="1">Pick up the index of the first item from <a href="41983.html">41983</a></td>
</tr>
<tr>
<td class="address-1"><span id="37846"></span>37846</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first byte of the first entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37847"></span>
<div class="comments">
<div class="paragraph">
The item-drawing loop begins here.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37847"></span>37847</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the first byte of the current entry in the item table</td>
</tr>
<tr>
<td class="address-1"><span id="37848"></span>37848</td>
<td class="instruction">RES 7,C</td>
<td class="comment-1" rowspan="1">Reset bit 7; bit 6 holds the collection flag, and bits 0-5 hold the room number</td>
</tr>
<tr>
<td class="address-1"><span id="37850"></span>37850</td>
<td class="instruction">LD A,(33824)</td>
<td class="comment-1" rowspan="1">Pick up the number of the current room from <a href="33824.html">33824</a></td>
</tr>
<tr>
<td class="address-1"><span id="37853"></span>37853</td>
<td class="instruction">OR 64</td>
<td class="comment-1" rowspan="1">Set bit 6 (corresponding to the collection flag)</td>
</tr>
<tr>
<td class="address-1"><span id="37855"></span>37855</td>
<td class="instruction">CP C</td>
<td class="comment-1" rowspan="1">Is the item in the current room and still uncollected?</td>
</tr>
<tr>
<td class="address-1"><span id="37856"></span>37856</td>
<td class="instruction">JR NZ,<a href="37841.html#37970">37970</a></td>
<td class="comment-1" rowspan="1">If not, jump to consider the next entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37858"></span>
<div class="comments">
<div class="paragraph">
This item is in the current room and has not been collected yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="37858"></span>37858</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the first byte of the current entry in the item table</td>
</tr>
<tr>
<td class="address-1"><span id="37859"></span>37859</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="7">Point <span class="register">DE</span> at the location of the item in the attribute buffer at <a href="23552.html">23552</a></td>
</tr>
<tr>
<td class="address-1"><span id="37860"></span>37860</td>
<td class="instruction">AND 1</td>
</tr>
<tr>
<td class="address-1"><span id="37862"></span>37862</td>
<td class="instruction">ADD A,92</td>
</tr>
<tr>
<td class="address-1"><span id="37864"></span>37864</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="37865"></span>37865</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="37866"></span>37866</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="37867"></span>37867</td>
<td class="instruction">DEC H</td>
</tr>
<tr>
<td class="address-1"><span id="37868"></span>37868</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick up the current attribute byte at the item's location</td>
</tr>
<tr>
<td class="address-1"><span id="37869"></span>37869</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="2">Is the INK white (which happens if Willy is touching the item, or the room's background tile has white INK, as in <a href="57088.html">Swimming Pool</a>)?</td>
</tr>
<tr>
<td class="address-1"><span id="37871"></span>37871</td>
<td class="instruction">CP 7</td>
</tr>
<tr>
<td class="address-1"><span id="37873"></span>37873</td>
<td class="instruction">JR NZ,<a href="37841.html#37936">37936</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37875"></span>
<div class="comments">
<div class="paragraph">
Willy is touching this item (or the room's background tile has white INK), so add it to his collection.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="37875"></span>37875</td>
<td class="instruction">LD IX,34172</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> at the number of items collected at <a href="34172.html">34172</a></td>
</tr>
<tr>
<td class="address-2"><span id="37879"></span>37879</td>
<td class="instruction">INC (IX+2)</td>
<td class="comment-1" rowspan="1">Increment a digit of the number of items collected</td>
</tr>
<tr>
<td class="address-1"><span id="37882"></span>37882</td>
<td class="instruction">LD A,(IX+2)</td>
<td class="comment-1" rowspan="2">Was the digit originally '9'?</td>
</tr>
<tr>
<td class="address-1"><span id="37885"></span>37885</td>
<td class="instruction">CP 58</td>
</tr>
<tr>
<td class="address-1"><span id="37887"></span>37887</td>
<td class="instruction">JR NZ,<a href="37841.html#37897">37897</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="37889"></span>37889</td>
<td class="instruction">LD (IX+2),48</td>
<td class="comment-1" rowspan="1">Set the digit to '0'</td>
</tr>
<tr>
<td class="address-1"><span id="37893"></span>37893</td>
<td class="instruction">DEC IX</td>
<td class="comment-1" rowspan="1">Move back to the digit on the left</td>
</tr>
<tr>
<td class="address-1"><span id="37895"></span>37895</td>
<td class="instruction">JR <a href="37841.html#37879">37879</a></td>
<td class="comment-1" rowspan="1">Jump back to increment this digit</td>
</tr>
<tr>
<td class="address-2"><span id="37897"></span>37897</td>
<td class="instruction">LD A,(32990)</td>
<td class="comment-1" rowspan="1">Pick up the border colour for the current room from <a href="32990.html">32990</a></td>
</tr>
<tr>
<td class="address-1"><span id="37900"></span>37900</td>
<td class="instruction">LD C,128</td>
<td class="comment-1" rowspan="12">Produce the sound effect for collecting an item</td>
</tr>
<tr>
<td class="address-2"><span id="37902"></span>37902</td>
<td class="instruction">OUT (254),A</td>
</tr>
<tr>
<td class="address-1"><span id="37904"></span>37904</td>
<td class="instruction">XOR 24</td>
</tr>
<tr>
<td class="address-1"><span id="37906"></span>37906</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="37907"></span>37907</td>
<td class="instruction">LD A,144</td>
</tr>
<tr>
<td class="address-1"><span id="37909"></span>37909</td>
<td class="instruction">SUB C</td>
</tr>
<tr>
<td class="address-1"><span id="37910"></span>37910</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="37911"></span>37911</td>
<td class="instruction">LD A,E</td>
</tr>
<tr>
<td class="address-2"><span id="37912"></span>37912</td>
<td class="instruction">DJNZ <a href="37841.html#37912">37912</a></td>
</tr>
<tr>
<td class="address-1"><span id="37914"></span>37914</td>
<td class="instruction">DEC C</td>
</tr>
<tr>
<td class="address-1"><span id="37915"></span>37915</td>
<td class="instruction">DEC C</td>
</tr>
<tr>
<td class="address-1"><span id="37916"></span>37916</td>
<td class="instruction">JR NZ,<a href="37841.html#37902">37902</a></td>
</tr>
<tr>
<td class="address-1"><span id="37918"></span>37918</td>
<td class="instruction">LD A,(34270)</td>
<td class="comment-1" rowspan="3">Update the counter of items remaining at <a href="34270.html">34270</a>, and set the zero flag if there are no more items to collect</td>
</tr>
<tr>
<td class="address-1"><span id="37921"></span>37921</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="37922"></span>37922</td>
<td class="instruction">LD (34270),A</td>
</tr>
<tr>
<td class="address-1"><span id="37925"></span>37925</td>
<td class="instruction">JR NZ,<a href="37841.html#37932">37932</a></td>
<td class="comment-1" rowspan="1">Jump if there are any items still to be collected</td>
</tr>
<tr>
<td class="address-1"><span id="37927"></span>37927</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="2">Update the game mode indicator at <a href="34271.html">34271</a> to 1 (all items collected)</td>
</tr>
<tr>
<td class="address-1"><span id="37929"></span>37929</td>
<td class="instruction">LD (34271),A</td>
</tr>
<tr>
<td class="address-2"><span id="37932"></span>37932</td>
<td class="instruction">RES 6,(HL)</td>
<td class="comment-1" rowspan="1">Reset bit 6 of the first byte of the entry in the item table: the item has been collected</td>
</tr>
<tr>
<td class="address-1"><span id="37934"></span>37934</td>
<td class="instruction">JR <a href="37841.html#37970">37970</a></td>
<td class="comment-1" rowspan="1">Jump to consider the next entry in the item table</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37936"></span>
<div class="comments">
<div class="paragraph">
Willy is not touching this item, so draw it and cycle its INK colour.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37936"></span>37936</td>
<td class="instruction">LD A,(34251)</td>
<td class="comment-1" rowspan="5">Generate the INK colour for the item from the value of the minute counter at <a href="34251.html">34251</a> (0-255) and the index of the item in the item table (173-255)</td>
</tr>
<tr>
<td class="address-1"><span id="37939"></span>37939</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="37940"></span>37940</td>
<td class="instruction">AND 3</td>
</tr>
<tr>
<td class="address-1"><span id="37942"></span>37942</td>
<td class="instruction">ADD A,3</td>
</tr>
<tr>
<td class="address-1"><span id="37944"></span>37944</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="37945"></span>37945</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="4">Change the INK colour of the item in the attribute buffer at <a href="23552.html">23552</a></td>
</tr>
<tr>
<td class="address-1"><span id="37946"></span>37946</td>
<td class="instruction">AND 248</td>
</tr>
<tr>
<td class="address-1"><span id="37948"></span>37948</td>
<td class="instruction">OR C</td>
</tr>
<tr>
<td class="address-1"><span id="37949"></span>37949</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="37950"></span>37950</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="8">Point <span class="register">DE</span> at the location of the item in the screen buffer at <a href="24576.html">24576</a></td>
</tr>
<tr>
<td class="address-1"><span id="37951"></span>37951</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="37952"></span>37952</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="37953"></span>37953</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="37954"></span>37954</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="37955"></span>37955</td>
<td class="instruction">AND 8</td>
</tr>
<tr>
<td class="address-1"><span id="37957"></span>37957</td>
<td class="instruction">ADD A,96</td>
</tr>
<tr>
<td class="address-1"><span id="37959"></span>37959</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="37960"></span>37960</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save <span class="register">HL</span> briefly</td>
</tr>
<tr>
<td class="address-1"><span id="37961"></span>37961</td>
<td class="instruction">LD HL,32993</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the item graphic for the current room (at <a href="32993.html">32993</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="37964"></span>37964</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="1">There are eight pixel rows to copy</td>
</tr>
<tr>
<td class="address-1"><span id="37966"></span>37966</td>
<td class="instruction">CALL <a href="38545.html#38555">38555</a></td>
<td class="comment-1" rowspan="1">Draw the item to the screen buffer at <a href="24576.html">24576</a></td>
</tr>
<tr>
<td class="address-1"><span id="37969"></span>37969</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the item table pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37970"></span>
<div class="comments">
<div class="paragraph">
The current item has been dealt with (skipped, collected or drawn) as appropriate. Time to consider the next one.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37970"></span>37970</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the first byte of the next entry in the item table</td>
</tr>
<tr>
<td class="address-1"><span id="37971"></span>37971</td>
<td class="instruction">JR NZ,<a href="37841.html#37847">37847</a></td>
<td class="comment-1" rowspan="1">Jump back unless we've examined every entry</td>
</tr>
<tr>
<td class="address-1"><span id="37973"></span>37973</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37819.html">37819</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37841">Map</a></td>
<td class="next">
Next: <a href="37974.html">37974</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20200806</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/93D1.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>