<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 36147</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35914.html">35914</a>
</td>
<td class="up">Up: <a href="../maps/all.html#36147">Map</a></td>
<td class="next">
Next: <a href="36203.html">36203</a>
</td>
</tr>
</table>
<div class="description">36147: Draw the current room to the screen buffer at 28672</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="35090.html">35090</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="36147"></span>36147</td>
<td class="instruction">CALL <a href="36203.html">36203</a></td>
<td class="comment-1" rowspan="1">Fill the buffer at <a href="24064.html">24064</a> with attribute bytes for the current room</td>
</tr>
<tr>
<td class="address-1"><span id="36150"></span>36150</td>
<td class="instruction">LD IX,24064</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> at the first byte of the attribute buffer at <a href="24064.html">24064</a></td>
</tr>
<tr>
<td class="address-1"><span id="36154"></span>36154</td>
<td class="instruction">LD A,112</td>
<td class="comment-1" rowspan="2">Set the operand of the 'LD D,n' instruction at <a href="36147.html#36188">36188</a> (below) to 112</td>
</tr>
<tr>
<td class="address-1"><span id="36156"></span>36156</td>
<td class="instruction">LD (36189),A</td>
</tr>
<tr>
<td class="address-1"><span id="36159"></span>36159</td>
<td class="instruction">CALL <a href="36147.html#36171">36171</a></td>
<td class="comment-1" rowspan="1">Draw the tiles for the top half of the room to the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-1"><span id="36162"></span>36162</td>
<td class="instruction">LD IX,24320</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> at the 256th byte of the attribute buffer at <a href="24064.html">24064</a> in preparation for drawing the bottom half of the room; this instruction is redundant, since <span class="register">IX</span> already holds 24320</td>
</tr>
<tr>
<td class="address-1"><span id="36166"></span>36166</td>
<td class="instruction">LD A,120</td>
<td class="comment-1" rowspan="2">Set the operand of the 'LD D,n' instruction at <a href="36147.html#36188">36188</a> (below) to 120</td>
</tr>
<tr>
<td class="address-1"><span id="36168"></span>36168</td>
<td class="instruction">LD (36189),A</td>
</tr>
<tr>
<td class="address-2"><span id="36171"></span>36171</td>
<td class="instruction">LD C,0</td>
<td class="comment-1" rowspan="1"><span class="register">C</span> will count 256 tiles</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="36173"></span>
<div class="comments">
<div class="paragraph">
The following loop draws 256 tiles (for either the top half or the bottom half of the room) to the screen buffer at <a href="28672.html">28672</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="36173"></span>36173</td>
<td class="instruction">LD E,C</td>
<td class="comment-1" rowspan="1"><span class="register">E</span> holds the LSB of the screen buffer address</td>
</tr>
<tr>
<td class="address-1"><span id="36174"></span>36174</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Pick up an attribute byte from the buffer at <a href="24064.html">24064</a>; this identifies the type of tile (background, floor, wall, nasty, ramp or conveyor) to be drawn</td>
</tr>
<tr>
<td class="address-1"><span id="36177"></span>36177</td>
<td class="instruction">LD HL,32928</td>
<td class="comment-1" rowspan="3">Move <span class="register">HL</span> through the attribute bytes and graphic data of the background, floor, wall, nasty, ramp and conveyor tiles starting at <a href="32928.html">32928</a> until we find a byte that matches the attribute byte of the tile to be drawn; note that if a graphic data byte matches the attribute byte being searched for, the CPIR instruction can exit early, which is a <a href="../reference/bugs.html#corruptedConveyors">bug</a></td>
</tr>
<tr>
<td class="address-1"><span id="36180"></span>36180</td>
<td class="instruction">LD BC,54</td>
</tr>
<tr>
<td class="address-1"><span id="36183"></span>36183</td>
<td class="instruction">CPIR</td>
</tr>
<tr>
<td class="address-1"><span id="36185"></span>36185</td>
<td class="instruction">LD C,E</td>
<td class="comment-1" rowspan="1">Restore the value of the tile counter in <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="36186"></span>36186</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="1">There are eight bytes in the tile</td>
</tr>
<tr>
<td class="address-1"><span id="36188"></span>36188</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="1">This instruction is set to either 'LD D,112' or 'LD D,120' above; now <span class="register">DE</span> holds the appropriate address in the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-2"><span id="36190"></span>36190</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="5">Copy the tile graphic data to the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-1"><span id="36191"></span>36191</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="36192"></span>36192</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="36193"></span>36193</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="36194"></span>36194</td>
<td class="instruction">DJNZ <a href="36147.html#36190">36190</a></td>
</tr>
<tr>
<td class="address-1"><span id="36196"></span>36196</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Move <span class="register">IX</span> along to the next byte in the attribute buffer</td>
</tr>
<tr>
<td class="address-1"><span id="36198"></span>36198</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Have we drawn 256 tiles yet?</td>
</tr>
<tr>
<td class="address-1"><span id="36199"></span>36199</td>
<td class="instruction">JP NZ,<a href="36147.html#36173">36173</a></td>
<td class="comment-1" rowspan="1">If not, jump back to draw the next one</td>
</tr>
<tr>
<td class="address-1"><span id="36202"></span>36202</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35914.html">35914</a>
</td>
<td class="up">Up: <a href="../maps/all.html#36147">Map</a></td>
<td class="next">
Next: <a href="36203.html">36203</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20200806</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/8D33.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>