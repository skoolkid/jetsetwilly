<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 38455</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="38430.html">38430</a>
</td>
<td class="up">Up: <a href="../maps/all.html#38455">Map</a></td>
<td class="next">
Next: <a href="38528.html">38528</a>
</td>
</tr>
</table>
<div class="description">38455: Draw Willy to the screen buffer at 24576</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="38344.html">38344</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">y-coordinate offset (0, 4, 8 or 12)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="38455"></span>38455</td>
<td class="instruction">LD A,(34255)</td>
<td class="comment-1" rowspan="1">Pick up Willy's y-coordinate from <a href="34255.html">34255</a></td>
</tr>
<tr>
<td class="address-1"><span id="38458"></span>38458</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1">Add the y-coordinate offset (to get Willy's true y-coordinate if he's standing on a ramp)</td>
</tr>
<tr>
<td class="address-1"><span id="38459"></span>38459</td>
<td class="instruction">LD IXh,130</td>
<td class="comment-1" rowspan="2">Point <span class="register">IX</span> at the entry in the screen buffer address lookup table at <a href="33280.html">33280</a> that corresponds to Willy's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="38462"></span>38462</td>
<td class="instruction">LD IXl,A</td>
</tr>
<tr>
<td class="address-1"><span id="38464"></span>38464</td>
<td class="instruction">LD A,(34256)</td>
<td class="comment-1" rowspan="1">Pick up Willy's direction and movement flags from <a href="34256.html">34256</a></td>
</tr>
<tr>
<td class="address-1"><span id="38467"></span>38467</td>
<td class="instruction">AND 1</td>
<td class="comment-1" rowspan="3">Now <span class="register">E</span>=0 if Willy is facing right, or 128 if he's facing left</td>
</tr>
<tr>
<td class="address-1"><span id="38469"></span>38469</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="38470"></span>38470</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="38471"></span>38471</td>
<td class="instruction">LD A,(34258)</td>
<td class="comment-1" rowspan="1">Pick up Willy's animation frame (0-3) from <a href="34258.html">34258</a></td>
</tr>
<tr>
<td class="address-1"><span id="38474"></span>38474</td>
<td class="instruction">AND 3</td>
<td class="comment-1" rowspan="7">Point <span class="register">DE</span> at the sprite graphic data for Willy's current animation frame (see <a href="40192.html">40192</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="38476"></span>38476</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="38477"></span>38477</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="38478"></span>38478</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="38479"></span>38479</td>
<td class="instruction">OR E</td>
</tr>
<tr>
<td class="address-1"><span id="38480"></span>38480</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="38481"></span>38481</td>
<td class="instruction">LD D,157</td>
</tr>
<tr>
<td class="address-1"><span id="38483"></span>38483</td>
<td class="instruction">LD A,(33824)</td>
<td class="comment-1" rowspan="1">Pick up the number of the current room from <a href="33824.html">33824</a></td>
</tr>
<tr>
<td class="address-1"><span id="38486"></span>38486</td>
<td class="instruction">CP 29</td>
<td class="comment-1" rowspan="1">Are we in the <a href="56576.html">The Nightmare Room</a>?</td>
</tr>
<tr>
<td class="address-1"><span id="38488"></span>38488</td>
<td class="instruction">JR NZ,<a href="38455.html#38496">38496</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="38490"></span>38490</td>
<td class="instruction">LD D,182</td>
<td class="comment-1" rowspan="4">Point <span class="register">DE</span> at the graphic data for the flying pig sprite (<a href="43776.html#46592">46592</a>+<span class="register">E</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="38492"></span>38492</td>
<td class="instruction">LD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="38493"></span>38493</td>
<td class="instruction">XOR 128</td>
</tr>
<tr>
<td class="address-1"><span id="38495"></span>38495</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-2"><span id="38496"></span>38496</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="1">There are 16 rows of pixels to copy</td>
</tr>
<tr>
<td class="address-1"><span id="38498"></span>38498</td>
<td class="instruction">LD A,(34259)</td>
<td class="comment-1" rowspan="2">Pick up Willy's screen x-coordinate (0-31) from <a href="34259.html">34259</a></td>
</tr>
<tr>
<td class="address-1"><span id="38501"></span>38501</td>
<td class="instruction">AND 31</td>
</tr>
<tr>
<td class="address-1"><span id="38503"></span>38503</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Copy it to <span class="register">C</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="38504"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="38298.html">38298</a> to draw the toilet in <a href="57600.html">The Bathroom</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="38504"></span>38504</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="4">Set <span class="register">HL</span> to the address in the screen buffer at <a href="24576.html">24576</a> that corresponds to where we are going to draw the next pixel row of the sprite graphic</td>
</tr>
<tr>
<td class="address-1"><span id="38507"></span>38507</td>
<td class="instruction">LD H,(IX+1)</td>
</tr>
<tr>
<td class="address-1"><span id="38510"></span>38510</td>
<td class="instruction">OR C</td>
</tr>
<tr>
<td class="address-1"><span id="38511"></span>38511</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="38512"></span>38512</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick up a sprite graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="38513"></span>38513</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">Merge it with the background</td>
</tr>
<tr>
<td class="address-1"><span id="38514"></span>38514</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Save the resultant byte to the screen buffer</td>
</tr>
<tr>
<td class="address-1"><span id="38515"></span>38515</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Move <span class="register">HL</span> along to the next cell to the right</td>
</tr>
<tr>
<td class="address-1"><span id="38516"></span>38516</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next sprite graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="38517"></span>38517</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick it up in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="38518"></span>38518</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">Merge it with the background</td>
</tr>
<tr>
<td class="address-1"><span id="38519"></span>38519</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Save the resultant byte to the screen buffer</td>
</tr>
<tr>
<td class="address-1"><span id="38520"></span>38520</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="2">Point <span class="register">IX</span> at the next entry in the screen buffer address lookup table at <a href="33280.html">33280</a></td>
</tr>
<tr>
<td class="address-1"><span id="38522"></span>38522</td>
<td class="instruction">INC IX</td>
</tr>
<tr>
<td class="address-1"><span id="38524"></span>38524</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next sprite graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="38525"></span>38525</td>
<td class="instruction">DJNZ <a href="38455.html#38504">38504</a></td>
<td class="comment-1" rowspan="1">Jump back until all 16 rows of pixels have been drawn</td>
</tr>
<tr>
<td class="address-1"><span id="38527"></span>38527</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="38430.html">38430</a>
</td>
<td class="up">Up: <a href="../maps/all.html#38455">Map</a></td>
<td class="next">
Next: <a href="38528.html">38528</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20221122</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/9637.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>