<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 35841</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35591.html">35591</a>
</td>
<td class="up">Up: <a href="../maps/all.html#35841">Map</a></td>
<td class="next">
Next: <a href="35914.html">35914</a>
</td>
</tr>
</table>
<div class="description">35841: Lose a life</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="35591.html">35591</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="35841"></span>35841</td>
<td class="instruction">LD A,71</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=71 (INK 7: PAPER 0: BRIGHT 1)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="35843"></span>
<div class="comments">
<div class="paragraph">
The following loop fills the top two thirds of the attribute file with a single value (71, 70, 69, 68, 67, 66, 65 or 64) and makes a sound effect.
</div>
<div class="paragraph">
<audio controls="" src="../../audio/die.wav">
<p>Your browser doesn't support HTML5 audio. Here is a <a href="../../audio/die.wav">link to the audio</a> instead.</p>
</audio>
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="35843"></span>35843</td>
<td class="instruction">LD HL,22528</td>
<td class="comment-1" rowspan="5">Fill the top two thirds of the attribute file with the value in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="35846"></span>35846</td>
<td class="instruction">LD DE,22529</td>
</tr>
<tr>
<td class="address-1"><span id="35849"></span>35849</td>
<td class="instruction">LD BC,511</td>
</tr>
<tr>
<td class="address-1"><span id="35852"></span>35852</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="35853"></span>35853</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="35855"></span>35855</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Save the attribute byte (64-71) in <span class="register">E</span> for later retrieval</td>
</tr>
<tr>
<td class="address-1"><span id="35856"></span>35856</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="7"><span class="register">D</span>=63-8*(<span class="register">E</span> AND 7); this value determines the pitch of the short note that will be played</td>
</tr>
<tr>
<td class="address-1"><span id="35857"></span>35857</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="35859"></span>35859</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="35860"></span>35860</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="35861"></span>35861</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="35862"></span>35862</td>
<td class="instruction">OR 7</td>
</tr>
<tr>
<td class="address-1"><span id="35864"></span>35864</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="35865"></span>35865</td>
<td class="instruction">LD C,E</td>
<td class="comment-1" rowspan="4"><span class="register">C</span>=8+32*(<span class="register">E</span> AND 7); this value determines the duration of the short note that will be played</td>
</tr>
<tr>
<td class="address-1"><span id="35866"></span>35866</td>
<td class="instruction">RRC C</td>
</tr>
<tr>
<td class="address-1"><span id="35868"></span>35868</td>
<td class="instruction">RRC C</td>
</tr>
<tr>
<td class="address-1"><span id="35870"></span>35870</td>
<td class="instruction">RRC C</td>
</tr>
<tr>
<td class="address-1"><span id="35872"></span>35872</td>
<td class="instruction">OR 16</td>
<td class="comment-1" rowspan="1">Set bit 4 of <span class="register">A</span> (for no apparent reason)</td>
</tr>
<tr>
<td class="address-1"><span id="35874"></span>35874</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span>=0 (this will make the border black)</td>
</tr>
<tr>
<td class="address-2"><span id="35875"></span>35875</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-1" rowspan="6">Produce a short note whose pitch is determined by <span class="register">D</span> and whose duration is determined by <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="35877"></span>35877</td>
<td class="instruction">XOR 24</td>
</tr>
<tr>
<td class="address-1"><span id="35879"></span>35879</td>
<td class="instruction">LD B,D</td>
</tr>
<tr>
<td class="address-2"><span id="35880"></span>35880</td>
<td class="instruction">DJNZ <a href="35841.html#35880">35880</a></td>
</tr>
<tr>
<td class="address-1"><span id="35882"></span>35882</td>
<td class="instruction">DEC C</td>
</tr>
<tr>
<td class="address-1"><span id="35883"></span>35883</td>
<td class="instruction">JR NZ,<a href="35841.html#35875">35875</a></td>
</tr>
<tr>
<td class="address-1"><span id="35885"></span>35885</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1">Restore the attribute byte (originally 71) to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="35886"></span>35886</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrement it (effectively decrementing the INK colour)</td>
</tr>
<tr>
<td class="address-1"><span id="35887"></span>35887</td>
<td class="instruction">CP 63</td>
<td class="comment-1" rowspan="1">Have we used attribute value 64 (INK 0) yet?</td>
</tr>
<tr>
<td class="address-1"><span id="35889"></span>35889</td>
<td class="instruction">JR NZ,<a href="35841.html#35843">35843</a></td>
<td class="comment-1" rowspan="1">If not, jump back to update the INK colour in the top two thirds of the screen and make another sound effect</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="35891"></span>
<div class="comments">
<div class="paragraph">
Now check whether any lives remain.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="35891"></span>35891</td>
<td class="instruction">LD HL,34252</td>
<td class="comment-1" rowspan="2">Pick up the number of lives remaining from <a href="34252.html">34252</a></td>
</tr>
<tr>
<td class="address-1"><span id="35894"></span>35894</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="35895"></span>35895</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Are there any lives remaining?</td>
</tr>
<tr>
<td class="address-1"><span id="35896"></span>35896</td>
<td class="instruction">JP Z,<a href="35914.html">35914</a></td>
<td class="comment-1" rowspan="1">If not, display the game over sequence</td>
</tr>
<tr>
<td class="address-1"><span id="35899"></span>35899</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Decrease the number of lives remaining by one</td>
</tr>
<tr>
<td class="address-1"><span id="35900"></span>35900</td>
<td class="instruction">LD HL,34263</td>
<td class="comment-1" rowspan="4">Restore Willy's state upon entry to the room by copying the seven bytes at <a href="34263.html">34263</a> back into <a href="../buffers/gbuffer.html#34255">34255-34261</a></td>
</tr>
<tr>
<td class="address-1"><span id="35903"></span>35903</td>
<td class="instruction">LD DE,34255</td>
</tr>
<tr>
<td class="address-1"><span id="35906"></span>35906</td>
<td class="instruction">LD BC,7</td>
</tr>
<tr>
<td class="address-1"><span id="35909"></span>35909</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="35911"></span>35911</td>
<td class="instruction">JP <a href="35090.html">35090</a></td>
<td class="comment-1" rowspan="1">Reinitialise the room and resume the game</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35591.html">35591</a>
</td>
<td class="up">Up: <a href="../maps/all.html#35841">Map</a></td>
<td class="next">
Next: <a href="35914.html">35914</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20221122</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/8C01.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>