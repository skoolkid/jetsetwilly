<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 34499</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="34463.html">34463</a>
</td>
<td class="up">Up: <a href="../maps/all.html#34499">Map</a></td>
<td class="next">
Next: <a href="34620.html">34620</a>
</td>
</tr>
</table>
<div class="description">34499: Display the code entry screen</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="34463.html">34463</a>. Displays the code entry screen and waits for a code to be entered. Returns with the zero flag set if the code entered is correct.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Address of the message to print (<a href="34187.html">34187</a> or <a href="34219.html">34219</a>)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="34499"></span>34499</td>
<td class="instruction">LD DE,18432</td>
<td class="comment-1" rowspan="3">Print the message pointed to by <span class="register">IX</span> at (8,0)</td>
</tr>
<tr>
<td class="address-1"><span id="34502"></span>34502</td>
<td class="instruction">LD C,32</td>
</tr>
<tr>
<td class="address-1"><span id="34504"></span>34504</td>
<td class="instruction">CALL <a href="38528.html">38528</a></td>
</tr>
<tr>
<td class="address-1"><span id="34507"></span>34507</td>
<td class="instruction">LD HL,18498</td>
<td class="comment-1" rowspan="4">Print the graphic for the '1' key at (10,2)</td>
</tr>
<tr>
<td class="address-1"><span id="34510"></span>34510</td>
<td class="instruction">LD DE,39680</td>
</tr>
<tr>
<td class="address-1"><span id="34513"></span>34513</td>
<td class="instruction">LD C,0</td>
</tr>
<tr>
<td class="address-1"><span id="34515"></span>34515</td>
<td class="instruction">CALL <a href="37974.html">37974</a></td>
</tr>
<tr>
<td class="address-1"><span id="34518"></span>34518</td>
<td class="instruction">LD HL,18501</td>
<td class="comment-1" rowspan="2">Print the graphic for the '2' key at (10,5)</td>
</tr>
<tr>
<td class="address-1"><span id="34521"></span>34521</td>
<td class="instruction">CALL <a href="37974.html">37974</a></td>
</tr>
<tr>
<td class="address-1"><span id="34524"></span>34524</td>
<td class="instruction">LD HL,18504</td>
<td class="comment-1" rowspan="2">Print the graphic for the '3' key at (10,8)</td>
</tr>
<tr>
<td class="address-1"><span id="34527"></span>34527</td>
<td class="instruction">CALL <a href="37974.html">37974</a></td>
</tr>
<tr>
<td class="address-1"><span id="34530"></span>34530</td>
<td class="instruction">LD HL,18507</td>
<td class="comment-1" rowspan="2">Print the graphic for the '4' key at (10,11)</td>
</tr>
<tr>
<td class="address-1"><span id="34533"></span>34533</td>
<td class="instruction">CALL <a href="37974.html">37974</a></td>
</tr>
<tr>
<td class="address-1"><span id="34536"></span>34536</td>
<td class="instruction">LD HL,39808</td>
<td class="comment-1" rowspan="4">Copy the 128 attribute bytes from <a href="39808.html">39808</a> to the screen (lines 8, 9, 10 and 11)</td>
</tr>
<tr>
<td class="address-1"><span id="34539"></span>34539</td>
<td class="instruction">LD DE,22784</td>
</tr>
<tr>
<td class="address-1"><span id="34542"></span>34542</td>
<td class="instruction">LD BC,128</td>
</tr>
<tr>
<td class="address-1"><span id="34545"></span>34545</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="34547"></span>34547</td>
<td class="instruction">LD A,(23672)</td>
<td class="comment-1" rowspan="1">Collect the LSB of the system variable FRAMES</td>
</tr>
<tr>
<td class="address-1"><span id="34550"></span>34550</td>
<td class="instruction">ADD A,37</td>
<td class="comment-1" rowspan="2">Add 37 to this value and replace it; this ensures that the value collected on the second pass through this routine is different from the value collected on the first pass</td>
</tr>
<tr>
<td class="address-1"><span id="34552"></span>34552</td>
<td class="instruction">LD (23672),A</td>
</tr>
<tr>
<td class="address-1"><span id="34555"></span>34555</td>
<td class="instruction">CP 179</td>
<td class="comment-1" rowspan="1">Is the value between 0 and 178?</td>
</tr>
<tr>
<td class="address-1"><span id="34557"></span>34557</td>
<td class="instruction">JR C,<a href="34499.html#34561">34561</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="34559"></span>34559</td>
<td class="instruction">SUB 180</td>
<td class="comment-1" rowspan="1">Otherwise subtract 180; note that if the original value of the LSB of the system variable FRAMES was 142, this leaves <span class="register">A</span> holding 255, which is a <a href="../reference/bugs.html#invalidGridLocation">bug</a></td>
</tr>
<tr>
<td class="address-2"><span id="34561"></span>34561</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Now <span class="register">L</span> holds either 255 or some number between 0 and 178</td>
</tr>
<tr>
<td class="address-1"><span id="34562"></span>34562</td>
<td class="instruction">LD H,158</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at one of the entries in the table at <a href="40448.html">40448</a> (or at 40703 if <span class="register">L</span>=255)</td>
</tr>
<tr>
<td class="address-1"><span id="34564"></span>34564</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up the table entry</td>
</tr>
<tr>
<td class="address-1"><span id="34565"></span>34565</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="1">Add <span class="register">L</span> to obtain the actual code</td>
</tr>
<tr>
<td class="address-1"><span id="34566"></span>34566</td>
<td class="instruction">LD (34276),A</td>
<td class="comment-1" rowspan="1">Store the code at <a href="34276.html">34276</a></td>
</tr>
<tr>
<td class="address-1"><span id="34569"></span>34569</td>
<td class="instruction">LD C,L</td>
<td class="comment-1" rowspan="1">Copy the code index to <span class="register">C</span>; this will be used to compute the grid location</td>
</tr>
<tr>
<td class="address-1"><span id="34570"></span>34570</td>
<td class="instruction">LD E,47</td>
<td class="comment-1" rowspan="8">Calculate the ASCII code of the grid location number (0-9) in <span class="register">E</span></td>
</tr>
<tr>
<td class="address-2"><span id="34572"></span>34572</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="address-1"><span id="34573"></span>34573</td>
<td class="instruction">LD A,C</td>
</tr>
<tr>
<td class="address-1"><span id="34574"></span>34574</td>
<td class="instruction">CP 18</td>
</tr>
<tr>
<td class="address-1"><span id="34576"></span>34576</td>
<td class="instruction">JR C,<a href="34499.html#34583">34583</a></td>
</tr>
<tr>
<td class="address-1"><span id="34578"></span>34578</td>
<td class="instruction">SUB 18</td>
</tr>
<tr>
<td class="address-1"><span id="34580"></span>34580</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="34581"></span>34581</td>
<td class="instruction">JR <a href="34499.html#34572">34572</a></td>
</tr>
<tr>
<td class="address-2"><span id="34583"></span>34583</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Print the grid location number at (8,30)</td>
</tr>
<tr>
<td class="address-1"><span id="34584"></span>34584</td>
<td class="instruction">LD DE,18462</td>
</tr>
<tr>
<td class="address-1"><span id="34587"></span>34587</td>
<td class="instruction">CALL <a href="38545.html">38545</a></td>
</tr>
<tr>
<td class="address-1"><span id="34590"></span>34590</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="2">Calculate the ASCII code of the grid location letter (A-R) in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="34591"></span>34591</td>
<td class="instruction">ADD A,65</td>
</tr>
<tr>
<td class="address-1"><span id="34593"></span>34593</td>
<td class="instruction">LD DE,18461</td>
<td class="comment-1" rowspan="2">Print the grid location letter at (8,29)</td>
</tr>
<tr>
<td class="address-1"><span id="34596"></span>34596</td>
<td class="instruction">CALL <a href="38545.html">38545</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="34599"></span>
<div class="comments">
<div class="paragraph">
Here we enter a loop that prints a 2x2 coloured block at (10,16), (10,19), (10,22) or (10,25) whenever '1', '2', '3' or '4' is pressed, or returns to the calling routine at <a href="34463.html">34463</a> if ENTER is pressed.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="34599"></span>34599</td>
<td class="instruction">LD IX,22864</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> at the attribute file location of the first coloured block at (10,16)</td>
</tr>
<tr>
<td class="address-2"><span id="34603"></span>34603</td>
<td class="instruction">CALL <a href="34620.html">34620</a></td>
<td class="comment-1" rowspan="1">Print a coloured block when '1', '2', '3' or '4' is pressed, or return to <a href="34463.html">34463</a> if ENTER is pressed</td>
</tr>
<tr>
<td class="address-1"><span id="34606"></span>34606</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="3">Move <span class="register">IX</span> along to the location of the next coloured block</td>
</tr>
<tr>
<td class="address-1"><span id="34608"></span>34608</td>
<td class="instruction">INC IX</td>
</tr>
<tr>
<td class="address-1"><span id="34610"></span>34610</td>
<td class="instruction">INC IX</td>
</tr>
<tr>
<td class="address-1"><span id="34612"></span>34612</td>
<td class="instruction">LD A,IXl</td>
<td class="comment-1" rowspan="2">Have we just printed the fourth coloured block at (10,25)?</td>
</tr>
<tr>
<td class="address-1"><span id="34614"></span>34614</td>
<td class="instruction">CP 92</td>
</tr>
<tr>
<td class="address-1"><span id="34616"></span>34616</td>
<td class="instruction">JR NZ,<a href="34499.html#34603">34603</a></td>
<td class="comment-1" rowspan="1">If not, jump back to print the next one</td>
</tr>
<tr>
<td class="address-1"><span id="34618"></span>34618</td>
<td class="instruction">JR <a href="34499.html#34599">34599</a></td>
<td class="comment-1" rowspan="1">Otherwise rewind <span class="register">IX</span> to the location of the first coloured block</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="34463.html">34463</a>
</td>
<td class="up">Up: <a href="../maps/all.html#34499">Map</a></td>
<td class="next">
Next: <a href="34620.html">34620</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20221122</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/86C3.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>