<!DOCTYPE html>
<html>
<head>
<title>Jet Set Willy: Routine at 37974</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Jet Set Willy" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37841.html">37841</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37974">Map</a></td>
<td class="next">
Next: <a href="38026.html">38026</a>
</td>
</tr>
</table>
<div class="description">37974: Draw a sprite</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="34499.html">34499</a> (to draw the number key graphics on the code entry screen), <a href="35211.html">35211</a> (to draw the remaining lives), <a href="35914.html">35914</a> (to draw Willy, the foot and the barrel during the game over sequence), <a href="37310.html">37310</a> (to draw guardians in the current room) and <a href="38196.html">38196</a> (to draw Maria in <a href="58112.html">Master Bedroom</a>). If <span class="register">C</span>=1 on entry, this routine returns with the zero flag reset if any of the set bits in the sprite being drawn collides with a set bit in the background.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Drawing mode: 0 (overwrite) or 1 (blend)</td>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Address of sprite graphic data</td>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address to draw at</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="37974"></span>37974</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="1">There are 16 rows of pixels to draw</td>
</tr>
<tr>
<td class="address-2"><span id="37976"></span>37976</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Set the zero flag if we're in overwrite mode</td>
</tr>
<tr>
<td class="address-1"><span id="37978"></span>37978</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick up a sprite graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="37979"></span>37979</td>
<td class="instruction">JR Z,<a href="37974.html#37985">37985</a></td>
<td class="comment-1" rowspan="1">Jump if we're in overwrite mode</td>
</tr>
<tr>
<td class="address-1"><span id="37981"></span>37981</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="2">Return with the zero flag reset if any of the set bits in the sprite graphic byte collide with a set bit in the background (e.g. in Willy's sprite)</td>
</tr>
<tr>
<td class="address-1"><span id="37982"></span>37982</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="37983"></span>37983</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick up the sprite graphic byte again</td>
</tr>
<tr>
<td class="address-1"><span id="37984"></span>37984</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">Blend it with the background byte</td>
</tr>
<tr>
<td class="address-2"><span id="37985"></span>37985</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Copy the graphic byte to its destination cell</td>
</tr>
<tr>
<td class="address-1"><span id="37986"></span>37986</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Move <span class="register">HL</span> along to the next cell on the right</td>
</tr>
<tr>
<td class="address-1"><span id="37987"></span>37987</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next sprite graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="37988"></span>37988</td>
<td class="instruction">BIT 0,C</td>
<td class="comment-1" rowspan="1">Set the zero flag if we're in overwrite mode</td>
</tr>
<tr>
<td class="address-1"><span id="37990"></span>37990</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick up a sprite graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="37991"></span>37991</td>
<td class="instruction">JR Z,<a href="37974.html#37997">37997</a></td>
<td class="comment-1" rowspan="1">Jump if we're in overwrite mode</td>
</tr>
<tr>
<td class="address-1"><span id="37993"></span>37993</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="2">Return with the zero flag reset if any of the set bits in the sprite graphic byte collide with a set bit in the background (e.g. in Willy's sprite)</td>
</tr>
<tr>
<td class="address-1"><span id="37994"></span>37994</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="address-1"><span id="37995"></span>37995</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Pick up the sprite graphic byte again</td>
</tr>
<tr>
<td class="address-1"><span id="37996"></span>37996</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">Blend it with the background byte</td>
</tr>
<tr>
<td class="address-2"><span id="37997"></span>37997</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Copy the graphic byte to its destination cell</td>
</tr>
<tr>
<td class="address-1"><span id="37998"></span>37998</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Move <span class="register">HL</span> to the next pixel row down in the cell on the left</td>
</tr>
<tr>
<td class="address-1"><span id="37999"></span>37999</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="38000"></span>38000</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the next sprite graphic byte</td>
</tr>
<tr>
<td class="address-1"><span id="38001"></span>38001</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2">Have we drawn the bottom pixel row in this pair of cells yet?</td>
</tr>
<tr>
<td class="address-1"><span id="38002"></span>38002</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="38004"></span>38004</td>
<td class="instruction">JR NZ,<a href="37974.html#38022">38022</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="38006"></span>38006</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="6">Otherwise move <span class="register">HL</span> to the top pixel row in the cell below</td>
</tr>
<tr>
<td class="address-1"><span id="38007"></span>38007</td>
<td class="instruction">SUB 8</td>
</tr>
<tr>
<td class="address-1"><span id="38009"></span>38009</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="38010"></span>38010</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="38011"></span>38011</td>
<td class="instruction">ADD A,32</td>
</tr>
<tr>
<td class="address-1"><span id="38013"></span>38013</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="38014"></span>38014</td>
<td class="instruction">AND 224</td>
<td class="comment-1" rowspan="1">Was the last pair of cells at y-coordinate 7 or 15?</td>
</tr>
<tr>
<td class="address-1"><span id="38016"></span>38016</td>
<td class="instruction">JR NZ,<a href="37974.html#38022">38022</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="38018"></span>38018</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">Otherwise adjust <span class="register">HL</span> to account for the movement from the top or middle third of the screen to the next one down</td>
</tr>
<tr>
<td class="address-1"><span id="38019"></span>38019</td>
<td class="instruction">ADD A,8</td>
</tr>
<tr>
<td class="address-1"><span id="38021"></span>38021</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-2"><span id="38022"></span>38022</td>
<td class="instruction">DJNZ <a href="37974.html#37976">37976</a></td>
<td class="comment-1" rowspan="1">Jump back until all 16 rows of pixels have been drawn</td>
</tr>
<tr>
<td class="address-1"><span id="38024"></span>38024</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set the zero flag (to indicate no collision)</td>
</tr>
<tr>
<td class="address-1"><span id="38025"></span>38025</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37841.html">37841</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37974">Map</a></td>
<td class="next">
Next: <a href="38026.html">38026</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Jet Set Willy RAM disassembly 20221122</div>
<div class="copyright">&#169; 1984 Software Projects Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/9456.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>